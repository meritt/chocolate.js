((function(){var a,b,c,d,e,f,g,h=Object.prototype.hasOwnProperty,i=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(h.call(this,b)&&this[b]===a)return b;return-1};c={actions:{overlay:!1,leftside:"prev",container:"next",rightside:"close"},thumbnails:!0,history:!0,basedir:"/chocolate"},f={"image-hover":'<span class="choco-item-hover" data-sglid="{{cid}}"></span>',overlay:'\n    <div class="choco-overlay">\n      <div class="choco-leftside"></div>\n      {{spinner}}\n      <div class="choco-container"></div>\n      <div class="choco-rightside"></div>\n      {{thumbnails}}\n      <div class="choco-close"></div>\n    </div>\n  ',spinner:'\n    <div class="choco-spinner">\n     <img src="{{basedir}}/images/spinner-bg.png" alt="">\n     <img src="{{basedir}}/images/spinner-serenity.png" alt="">\n    </div>\n  ',"image-title":'<div class="choco-header"><h1>{{title}}</h1></div>',thumbnails:'<div class="choco-thumbnails-toggle"></div><div class="choco-thumbnails"></div>',"thumbnails-item":'<div class="choco-thumbnail{{selected}}" data-cid="{{cid}}" style="background-image:url(\'{{thumbnail}}\')"{{title}}></div>'},b=0,d=["next","prev","close"],e=!!window.history&&!!history.pushState,g=function(a,b){return a.replace(/\{\{basedir\}\}/g,b)},a=function(){function a(a,b){var d,h,i,j,k,l,m,n,o=this;b==null&&(b={});if(!c||!f)throw"You don't have defaultOptions or templates variables";this.options=$.extend(c,b),this.options.history||(e=!1),i=f.overlay,i=i.replace("{{spinner}}",f.spinner),i=i.replace("{{thumbnails}}",this.options.thumbnails?f.thumbnails:""),i=g(i,this.options.basedir),this.overlay=$(i).appendTo("body"),h=["container","spinner","leftside","rightside"],this.options.thumbnails&&h.push("thumbnails");for(j=0,l=h.length;j<l;j++)d=h[j],this[d]=this.overlay.find(".choco-"+d);this.overlay.find(".choco-close").click(function(a){return o.close()}),n=["overlay","container","leftside","rightside"];for(k=0,m=n.length;k<m;k++)d=n[k],this._prepareActionFor(d);e&&$(window).bind("popstate",function(a){var b;b=o.getImageFromUri();if(b>0&&b!==o.current)return o.current===null?o.show(b):o.updateImage(b,!1)}),$(window).bind("keyup",function(a){if(o.overlay.hasClass("show"))switch(a.keyCode){case 27:return o.close();case 37:return o.prev();case 39:return o.next()}}),a&&this.add(a)}return a.prototype.images={},a.prototype.current=null,a.prototype._prepareActionFor=function(a){var b,c,e,f=this;return b=(e=this.options.actions[a],i.call(d,e)>=0)?this.options.actions[a]:!1,b&&(c=this[a].attr("class"),this[a].click(function(a){if($(a.target).hasClass(c))return f[b]()})),this},a.prototype.getImageFromUri=function(){var a;return a=window.location.hash,a?parseInt(a.replace("#image",""),10):0},a.prototype.add=function(a){var b,c,d,e;if(!a||a.length===0)return this;for(d=0,e=a.length;d<e;d++)c=a[d],b=null,c instanceof HTMLElement&&(b=$(c),c={source:b.attr("data-src")||b.parent().attr("href"),title:b.attr("data-title")||b.attr("title"),thumbnail:b.attr("src")}),this._addToGallery(c,b);return this},a.prototype._addToGallery=function(a,c){var d,e,g,h=this;if(!a.source)return;d=++b,a.thumbnail||(a.thumbnail=a.source),this.images[d]=a;if(c)return g=function(a,b){return a.stopPropagation(),a.preventDefault(),h.show(b)},c.addClass("choco-item").click(function(a){return g(a,d)}),e=new Image,e.src=a.thumbnail,e.onload=function(a){return c.before(f["image-hover"].replace("{{cid}}",d)),$("[data-sglid="+d+"]").css({width:c.width(),height:c.height()}).click(function(a){return g(a,d)})}},a.prototype.show=function(a){a==null&&(a=this.getImageFromUri()),a<=0&&(a=1);if(this.images[a]==null)throw"Image not found";return this.current===null&&(this.current=a),this.options.thumbnails&&this.createThumbnails(),this.updateImage(a),this.overlay.addClass("show"),this},a.prototype.close=function(){return this.overlay.removeClass("show"),this},a.prototype.next=function(){var a;return a=this.current+1,this.images[a]!=null&&this.updateImage(a),this},a.prototype.prev=function(){var a;return a=this.current-1,this.images[a]!=null&&this.updateImage(a),this},a.prototype.updateImage=function(a,b){var c;return b==null&&(b=!0),this.current=a,this.container.removeClass("show"),this.options.thumbnails&&(this.thumbnails.find(".selected").removeClass("selected"),this.thumbnails.find("[data-cid="+a+"]").addClass("selected")),e&&b&&(c=this.images[a].title?"Image: "+this.images[a].title:null,history.pushState(null,c,"#image"+a)),this.getImageSize(a,function(a){var b;return this.container.addClass("show"),b=this.images[a],this.updateDimensions(b.width,b.height),this.container.css("background-image","url("+b.source+")"),this.container.html(b.title?f["image-title"].replace("{{title}}",b.title):"")}),this},a.prototype.getImageSize=function(a,b){var c,d,e=this;return b==null&&(b=function(){}),d=this.images[a],!d.width||!d.height?(this.spinner.removeClass("hide"),c=new Image,c.src=d.source,c.onload=function(d){return e.spinner.addClass("hide"),e.images[a].width=c.width,e.images[a].height=c.height,delete c,b.call(e,a)}):b.call(this,a)},a.prototype.updateDimensions=function(a,b){var c,d,e,f,g,h,i,j;return g=!this.options.thumbnails||this.thumbnails.css("display")==="none"?0:this.thumbnails.height(),d=window.innerWidth,j=d-50,c=window.innerHeight,i=c-50-g,a>j&&(b=j*b/a,a=j),b>i&&(a=i*a/b,b=i),e=parseInt(a/2,10),h=parseInt(b/2,10),g>0&&(h+=parseInt(g/2,10)),f={width:d/2-e+"px",height:c+"px"},this.leftside.css(f),this.rightside.css(f),f={width:a,height:b,"margin-left":"-"+e+"px","margin-top":"-"+h+"px"},this.container.css(f),this.spinner.css(f),this},a.prototype.createThumbnails=function(){var a,b,c,d,e,g,h,i;if(!this.options.thumbnails||!this.current||this.images.length<=1)return this;i=this,c=this.images[this.current],b="",h=this.images;for(a in h)d=h[a],e=c.source!=null===d.source?" selected":"",g=f["thumbnails-item"],b+=g.replace("{{selected}}",e).replace("{{cid}}",a).replace("{{thumbnail}}",d.thumbnail).replace("{{title}}",d.title?' title="'+d.title+'"':"");return this.thumbnails.html(b).find(".choco-thumbnail").click(function(a){return i.updateImage(parseInt($(this).attr("data-cid"),10))}),this.overlay.find(".choco-thumbnails-toggle").click(function(a){var b;return b=i.thumbnails.hasClass("hide")?"removeClass":"addClass",i.thumbnails[b]("hide"),$(this)[b]("hide"),i.updateDimensions(c.width,c.height)}),this},a}(),window.chocolate=a,jQuery&&jQuery.fn&&(jQuery.fn.chocolate=function(){return new a(this,arguments[0])})})).call(this)